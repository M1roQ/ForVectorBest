# Папка `utils/`

В папке `utils` собраны вспомогательные скрипты для автоматизации подготовки данных, обучения моделей, предобработки изображений, конвертации аннотаций и интеграции детекции/распознавания. Скрипты предназначены для ускорения экспериментов, стандартизации пайплайнов и снижения рутины при работе с изображениями и аннотациями.

---

## Содержание

- [crops.py](#cropppy)
- [forest_train.py](#forest_trainpy)
- [gray_images.py](#gray_imagespy)
- [json_to_csv.py](#json_to_csvpy)
- [start_yolo_detection.py](#start_yolo_detectionpy)

---

## crops.py

**Назначение:**  
Автоматическое извлечение и сохранение кропов (областей интереса) из изображений на основе инференса модели детекции (YOLO). Используется для подготовки датасетов и генерации метаданных по кропам без ручной разметки.

**Принцип работы:**
- Загружает изображения из подпапок (например, `Good` и `Bad`) во входной директории.
- Для каждого изображения запускает модель детекции (YOLO), определяя bounding boxes для текстовых и объектных областей.
- Для каждого найденного бокса:
  - Проверяет валидность координат и минимальный размер.
  - Вырезает соответствующий кроп.
  - Сохраняет кроп в выходную директорию с уникальным именем.
  - Формирует структуру с метаданными о кропе (имя, координаты, класс).
- Для каждого исходного изображения сохраняет информацию о всех его кропах (имя, размер, список кропов с координатами и классами) в итоговый JSON-файл (`crops_data.json`).
- Скрипт не использует заранее размеченные аннотации, а генерирует их на лету с помощью модели.

**Пример запуска:**
```bash
python3 -m utils.crops
```

---

## forest_train.py

**Назначение:**  
Обучение и анализ модели случайного леса (Random Forest) на основе признаков, извлечённых из кропов изображений. Используется для задач классификации по геометрическим и позиционным признакам кропов.

**Принцип работы:**
- Загружает таблицу с метаданными по кропам (CSV, например, `crops.csv`).
- Фильтрует строки по количеству классов.
- Для каждого кропа вычисляет дополнительные признаки:
  - Центр изображения (`center_x`, `center_y`)
  - Смещенные координаты боксов относительно центра изображения
  - Ширина и высота кропа, их относительные значения
  - Центр кропа (`x`, `y`)
  - Площадь кропа
  - Соотношения сторон (ширина/высота и высота/ширина)
- Удаляет неиспользуемые столбцы.
- Формирует матрицу признаков `X` и вектор классов `y`.
- Делит данные на обучающую и тестовую выборки.
- Обучает модель случайного леса (`RandomForestClassifier`).
- Оценивает точность модели и выводит метрику accuracy.
- Выводит важности признаков (feature importances).
- Сохраняет обученную модель в файл `forest_model.pkl` с помощью `joblib`.

**Пример запуска:**
```bash
python3 -m utils.forest_train
```

---

## gray_images.py

**Назначение:**  
Предобработка изображений: преобразование в инвертированные и нормализованные оттенки серого. Используется для подготовки данных.

**Принцип работы:**
- Загружает изображения из указанной директории (поддерживаются `.jpg` и `.png`).
- Для каждого изображения:
  - Считывает изображение с помощью OpenCV.
  - Переводит изображение из BGR в RGB и преобразует к типу float64.
  - Инвертирует изображение (255 - значение пикселя).
  - Усредняет значения по каналам (получает псевдосерый канал).
  - Выполняет нормализацию: вычитает минимум, делит на максимум.
  - Преобразует результат обратно в диапазон [0, 255] и тип uint8.
  - Переводит обратно в BGR для совместимости с OpenCV.
  - Сохраняет итоговое изображение в папку с тем же именем файла.

**Пример запуска:**
```bash
python3 -m utils.gray_images
```

---

## json_to_csv.py

**Назначение:**  
Конвертация аннотаций из формата JSON (например, после кроппинга) в табличный формат CSV для последующего анализа или обучения моделей.

**Принцип работы:**
- Загружает JSON-файл с аннотациями, где для каждого изображения хранится список кропов с координатами и классами.
- Для каждого изображения и каждого кропа формирует строки с полями: имя исходного изображения, размеры, имя кропа, координаты, класс.
- Собирает все строки в pandas DataFrame и сохраняет в CSV-файл.

**Пример запуска:**
```bash
python3 -m utils.json_to_csv local_data/output/crops_data.json tmp/crops.csv
```

---

## start_yolo_detection.py

**Назначение:**  
Запуск обучения или инференса модели YOLO через командную строку.

**Принцип работы:**
- Позволяет выбрать режим работы: обучение (`train`) или предсказание (`predict`) через аргумент `--mode`.
- Для обучения:
  - Принимает путь к data.yaml, параметры обучения (эпохи, размер батча, размер изображений, модель и др.).
  - Запускает процесс обучения с выбранными параметрами.
- Для инференса:
  - Принимает путь к весам модели, путь к данным (изображение или папка), папку для сохранения результатов.
  - Запускает инференс и сохраняет результаты (например, изображения с боксами) в указанную директорию.
- Все параметры можно задать через аргументы командной строки.

**Примеры запуска:**
```bash
python3 -m utils.start_yolo_detection --mode train --data data.yaml --output_dir results/
python3 -m utils.start_yolo_detection --mode predict --weights weights.pt --source images/ --output_dir results/
```

---

## Рекомендации по использованию и расширению

- Все скрипты запускаются как модули через `python3 -m utils.<script_name>`.
- При добавлении новых утилит используйте говорящие имена файлов и описывайте их работу в этом README.
